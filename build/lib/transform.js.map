{"version":3,"sources":["../../src/lib/transform.js"],"names":[],"mappings":"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","file":"lib/transform.js","sourcesContent":["import { Replaceable } from 'restream'\nimport makeRules from '@a-la/markers'\nimport ALaImport from '@a-la/import'\nimport ALaExport from '@a-la/export'\nimport whichStream from 'which-stream'\nimport Catchment from 'catchment'\nimport { createReadStream } from 'fs'\nimport { basename, dirname, join } from 'path'\nimport { getMap } from './source-map'\n\nconst getConfig = () => {\n  let config = {}\n  try {\n    const r = join(process.cwd(), '.alamoderc.json')\n    config = require(r)\n  } catch (err) { /* no config */ }\n  const { env: { ALAMODE_ENV } } = process\n  const c = config.env && ALAMODE_ENV in config.env ? config.env[ALAMODE_ENV] : config\n\n  delete c.env\n\n  return c\n}\n\n\nconst makeReplaceable = () => {\n  const config = getConfig()\n  const { rules, markers } = makeRules([\n    ...ALaImport,\n    ...ALaExport,\n  ])\n  const replaceable = new Replaceable(rules)\n  replaceable.markers = markers\n\n  replaceable.config = config\n  return replaceable\n}\n\n/**\n * Run a transform stream.\n */\nexport const transformStream = async ({\n  source,\n  destination,\n  writable,\n}) => {\n  const replaceable = makeReplaceable()\n\n  const readable = createReadStream(source)\n\n  readable.pipe(replaceable)\n  const { promise: sourcePromise } = new Catchment({ rs: readable })\n\n  const [,, sourceCode] = await Promise.all([\n    whichStream({\n      source,\n      ...(writable ? { writable } : { destination }),\n      readable: replaceable,\n    }),\n    new Promise((r, j) => {\n      replaceable.once('error', j)\n      replaceable.once('end', r)\n    }),\n    sourcePromise,\n  ])\n\n  return sourceCode\n}\n\nclass Context {\n  constructor(markers) {\n    this.listeners = {}\n    this.markers = markers\n    this.config = getConfig()\n  }\n  on(event, listener) {\n    this.listeners[event] = listener\n  }\n  emit(event, data) {\n    this.listeners[event](data)\n  }\n}\n\n/**\n * @param {string} source Source code as a string.\n */\nexport const syncTransform = (source, filename) => {\n  const { rules, markers } = makeRules([\n    ...ALaImport,\n    ...ALaExport,\n  ])\n  const context = new Context(markers)\n\n  const replaced = rules.reduce((acc, { re, replacement }) => {\n    const newAcc = acc.replace(re, replacement.bind(context))\n    return newAcc\n  }, source)\n\n  const file = basename(filename)\n  const sourceRoot = dirname(filename)\n  const map = getMap({\n    originalSource: source,\n    pathToSrc: file,\n    sourceRoot,\n  })\n  const b64 = Buffer.from(map).toString('base64')\n  const s = `//# sourceMappingURL=data:application/json;charset=utf-8;base64,${b64}`\n\n  const code = `${replaced}\\n${s}`\n\n  return code\n}"]}