{"version":3,"sources":["../../src/lib/transform.js"],"names":[],"mappings":"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","file":"lib/transform.js","sourcesContent":["import { Replaceable } from 'restream'\nimport makeRules from '@a-la/markers'\nimport ALaImport from '@a-la/import'\nimport ALaExport from '@a-la/export'\nimport whichStream from 'which-stream'\nimport { collect } from 'catchment'\nimport { createReadStream } from 'fs'\nimport { basename, dirname, join } from 'path'\nimport { getMap } from './source-map'\n\nconst getConfig = () => {\n  let config = {}\n  try {\n    const r = join(process.cwd(), '.alamoderc.json')\n    config = require(r)\n  } catch (err) {\n    return config\n  }\n  const { env: { ALAMODE_ENV } } = process\n  const c = config.env && ALAMODE_ENV in config.env ? config.env[ALAMODE_ENV] : config\n\n  delete c.env\n\n  return c\n}\n\nconst getRules = () => {\n  const r = [\n    ...ALaImport,\n    ...ALaExport,\n  ]\n  const { rules, markers } = makeRules(r)\n  return { rules, markers }\n}\n\nexport class ALaMode extends Replaceable {\n  constructor() {\n    const config = getConfig()\n    const { rules, markers } = getRules()\n    super(rules)\n\n    this.markers = markers\n    this.config = config\n  }\n}\n\n/**\n * Run a transform stream, and return the source code that was transformed.\n */\nexport const transformStream = async ({\n  source,\n  destination,\n  writable,\n}) => {\n  const alamode = new ALaMode()\n\n  const readable = createReadStream(source)\n\n  readable.pipe(alamode)\n  readable.on('error', e => alamode.emit('error', e))\n\n  const [, sourceCode] = await Promise.all([\n    whichStream({\n      source,\n      ...(writable ? { writable } : { destination }),\n      readable: alamode,\n    }),\n    collect(readable),\n    new Promise((r, j) => alamode.on('finish', r).on('error', j)),\n  ])\n  return sourceCode\n}\n\nclass Context {\n  constructor(config, markers) {\n    this.listeners = {}\n    this.markers = markers\n    this.config = config\n  }\n  on(event, listener) {\n    this.listeners[event] = listener\n  }\n  emit(event, data) {\n    this.listeners[event](data)\n  }\n}\n\nexport const transformString = (source) => {\n  const config = getConfig()\n  const { rules, markers } = getRules()\n  const context = new Context(config, markers)\n\n  const replaced = rules.reduce((acc, { re, replacement }) => {\n    const newAcc = acc.replace(re, replacement.bind(context))\n    return newAcc\n  }, source)\n  return replaced\n}\n\n/**\n * @param {string} source Source code as a string.\n */\nexport const syncTransform = (source, filename, advanced) => {\n  const replaced = transformString(source, advanced)\n  const file = basename(filename)\n  const sourceRoot = dirname(filename)\n  const map = getMap({\n    originalSource: source,\n    pathToSrc: file,\n    sourceRoot,\n  })\n  const b64 = Buffer.from(map).toString('base64')\n  const s = `//# sourceMappingURL=data:application/json;charset=utf-8;base64,${b64}`\n\n  const code = `${replaced}\\n${s}`\n\n  return code\n}"]}